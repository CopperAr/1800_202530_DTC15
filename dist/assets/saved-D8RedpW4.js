import{q as b,w as f,j as re,k as z,d as x,a as m,e as L,o as T,u as W,i as oe,b as se,c as K,g as ae}from"./site-footer-DBBnyLh7.js";import{onAuthReady as de}from"./authentication-DYev4ouI.js";document.addEventListener("DOMContentLoaded",()=>{const G=document.getElementById("calendar"),A=document.getElementById("eventForm"),D=document.getElementById("eventTitle"),M=document.getElementById("eventDate"),P=document.getElementById("eventStartTime"),U=document.getElementById("eventEndTime"),O=document.getElementById("repeatCount"),B=document.getElementById("repeatUnit"),v=document.getElementById("friendsScheduleList"),w=document.getElementById("myEventColor");if(!G||!A||!D||!M||!P||!U){console.warn("Schedule page DOM not fully loaded.");return}function H(){return window.matchMedia("(max-width: 576px)").matches}const I="#1447E6",R="#2AA63E";let d=null,E=null,p=new Map,N=new Map,l={eventColor:I,friendColors:{}};function $(e){return e?e===d?l.eventColor||I:(l.friendColors||{})[e]||R:I}const c=new window.FullCalendar.Calendar(G,{themeSystem:"bootstrap5",initialView:"dayGridMonth",height:"auto",expandRows:!0,dayMaxEventRows:!0,selectable:!0,headerToolbar:H()?{left:"prev,next today",center:"title",right:""}:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay"},buttonText:{today:"today",month:"month",week:"week",day:"day"},dateClick:e=>{M.value=e.dateStr,D.focus()},eventClick:async e=>{const o=e.event,{ownerId:s,ownerName:a,seriesId:t,type:n,hangoutId:r}=o.extendedProps||{};if(n==="hangout"){confirm(`Open this hangout?

"${o.title}"`)&&(window.location.href="hangout.html");return}if(s&&s!==d){alert(`This event belongs to ${a||"a friend"}.
You cannot delete it.`);return}const i=o.start?o.start.toLocaleString():"unknown",h=o.end?o.end.toLocaleString():"";if(confirm(`Delete "${o.title}"?
From: ${i}`+(h?`
To: ${h}`:"")))try{if(t&&E&&confirm(`This is part of a repeating series.

OK = delete ALL events in series.
Cancel = delete only this one.`)){const u=b(E,f("userId","==",d),f("seriesId","==",t)),k=await re(u);await Promise.all(k.docs.map(q=>z(q.ref)));return}await z(x(m,"events",o.id))}catch(C){console.error("Delete failed:",C),alert("Could not delete event.")}},windowResize:()=>{c.setOption("headerToolbar",H()?{left:"prev,next today",center:"title",right:""}:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay"})}});c.render();function g(){c.getEvents().forEach(e=>{const o=e.extendedProps?.ownerId;if(!o)return;const s=$(o);e.setProp("backgroundColor",s),e.setProp("borderColor",s)})}function V(e,o){const s=new Date(e+"T00:00");return s.setDate(s.getDate()+o),s.toISOString().slice(0,10)}function J(e,o){const s=new Date(e+"T00:00");return s.setMonth(s.getMonth()+o),s.toISOString().slice(0,10)}async function _(e){if(N.has(e))return N.get(e);let o=e;try{const s=await ae(x(m,"users",e));if(s.exists()){const a=s.data();o=a.displayName||a.name||a.email||e}}catch(s){console.error("Error loading user label:",s)}return N.set(e,o),o}function Y(e){c.getEvents().forEach(o=>{o.extendedProps?.ownerId===e&&o.extendedProps?.isFriend&&o.remove()})}function X(e,o){if(p.has(e))return;const s=b(L(m,"events"),f("userId","==",e)),a=T(s,t=>{Y(e),t.forEach(n=>{const r=n.data();c.addEvent({id:`friend_${e}_${n.id}`,title:`${o}: ${r.title}`,start:r.start,end:r.end||null,allDay:!1,color:$(e),extendedProps:{ownerId:e,ownerName:o,isFriend:!0,seriesId:r.seriesId||null}})}),g()},t=>console.error("Friend events error:",t));p.set(e,a)}function j(e){const o=p.get(e);o&&o(),p.delete(e),Y(e)}function Z(e){if(!v)return;const o=b(L(m,"friendships"),se(K(f("fromUserId","==",e),f("status","==","accepted")),K(f("toUserId","==",e),f("status","==","accepted"))));T(o,async s=>{v.innerHTML="";const a=new Map;s.forEach(t=>{const n=t.data(),r=n.fromUserId===e?n.toUserId:n.fromUserId;a.set(r,!0)});for(const t of p.keys())a.has(t)||j(t);if(!a.size){v.innerHTML='<p class="text-muted small mb-0">You have no friends added yet.</p>';return}for(const t of a.keys()){const n=await _(t),r=l.friendColors?.[t]||R,i=document.createElement("label");i.className="list-group-item d-flex justify-content-between align-items-center",i.innerHTML=`
                        <div class="d-flex justify-content-between align-items-center w-100">
                            <div>
                                <strong>${n}</strong>
                                <br><small class="text-muted">${t}</small>
                            </div>

                            <div class="d-flex align-items-center gap-2">
                                <!-- Friend color picker -->
                                <input
                                    type="color"
                                    class="form-control form-control-color friend-color-picker"
                                    data-friend-id="${t}"
                                    value="${r}"
                                >

                                <!-- Toggle switch -->
                                <div class="form-check form-switch m-0">
                                    <input
                                        class="form-check-input friend-toggle"
                                        type="checkbox"
                                        data-friend-id="${t}"
                                    >
                                </div>
                            </div>
                        </div>
                    `,v.appendChild(i)}v.querySelectorAll(".friend-toggle").forEach(t=>{const n=t.dataset.friendId;t.checked=p.has(n),t.addEventListener("change",async()=>{const r=await _(n);t.checked?X(n,r):j(n)})}),v.querySelectorAll(".friend-color-picker").forEach(t=>{const n=t.dataset.friendId;t.addEventListener("input",async()=>{const r=t.value;l.friendColors??={},l.friendColors[n]=r,g();try{await W(x(m,"users",d),{[`friendColors.${n}`]:r})}catch(i){console.error("Error saving friend color:",i)}})})},s=>console.error("Friendships error:",s))}function ee(){c.getEvents().forEach(e=>{e.extendedProps?.type==="hangout"&&e.remove()})}de(e=>{if(!e){window.location.href="login.html";return}d=e.uid,E=L(m,"events");const o=x(m,"users",d);T(o,t=>{if(!t.exists())return;const n=t.data();l.eventColor=n.eventColor||I,l.friendColors=n.friendColors||{},w&&(w.value=l.eventColor),g()},t=>console.error("Settings listener error:",t));const s=b(E,f("userId","==",d));T(s,t=>{c.getEvents().forEach(n=>{n.extendedProps?.ownerId===d&&n.extendedProps?.type!=="hangout"&&n.remove()}),t.forEach(n=>{const r=n.data();c.addEvent({id:n.id,title:r.title,start:r.start,end:r.end||null,allDay:!1,color:$(r.userId),extendedProps:{ownerId:r.userId,ownerName:"You",isFriend:!1,seriesId:r.seriesId||null,type:"schedule"}})}),g()},t=>console.error("Own events listener error:",t));const a=b(L(m,"hangouts"),f("userId","==",d));T(a,t=>{ee(),t.forEach(n=>{const r=n.data();if(!r.date)return;const i=`${r.date}T${r.startTime||"00:00"}`,h=r.endTime?`${r.date}T${r.endTime}`:null;c.addEvent({id:`hangout_${n.id}`,title:r.title||"Hangout",start:i,end:h,allDay:!1,color:$(r.userId),extendedProps:{ownerId:r.userId,ownerName:"You",type:"hangout",hangoutId:n.id}})}),g()},t=>console.error("Hangouts listener error:",t)),Z(d),w&&w.addEventListener("input",async()=>{const t=w.value||I;l.eventColor=t,g();try{await W(x(m,"users",d),{eventColor:t})}catch(n){console.error("Failed to save own event color:",n)}}),A.addEventListener("submit",async t=>{t.preventDefault();const n=D.value.trim(),r=M.value,i=P.value,h=U.value;let S=B?.value||"none",C=O?.value||"1";if(!n||!r||!i||!h){alert("Please fill all required fields.");return}let u=parseInt(C,10);(isNaN(u)||u<1)&&(u=1),u>52&&(u=52);const k=S!=="none"&&u>1,q=k&&window.crypto?.randomUUID?window.crypto.randomUUID():k?`series_${d}_${Date.now()}`:null,Q=[];for(let y=0;y<u;y++){let F=r;S==="week"?F=V(r,y*7):S==="month"&&(F=J(r,y));const te=`${F}T${i}`,ne=`${F}T${h}`;Q.push(oe(E,{userId:d,title:n,start:te,end:ne,seriesId:q}))}try{await Promise.all(Q),D.value="",P.value="",U.value="",O&&(O.value="1"),B&&(B.value="none")}catch(y){console.error("Failed to add event(s):",y),alert("Could not save events.")}})})});
