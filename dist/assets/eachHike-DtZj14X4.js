import{e as R,a as w,q as U,w as $,o as st,i as at,s as it,j as _,k as ot,d as j,g as ct,u as rt}from"./site-footer-DBBnyLh7.js";import{onAuthReady as dt}from"./authentication-DYev4ouI.js";function L(t,e){if(!e)return;const a=String(e).split(":").map(Number),r=a[0]||0,l=a[1]||0;t.setHours(r,l,0,0)}function A(t,e){if(t&&typeof t.toDate=="function"){const a=t.toDate();return L(a,e),a}if(t instanceof Date){const a=new Date(t.getTime());return L(a,e),a}if(typeof t=="string"){if(/^\d{4}-\d{2}-\d{2}$/.test(t)){const[r,l,h]=t.split("-").map(Number),u=new Date(r,l-1,h,0,0,0,0);return L(u,e),u}if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(t)){const[r,l,h]=t.split("/").map(Number),u=new Date(h,(r||1)-1,l||1,0,0,0,0);return L(u,e),u}const a=new Date(t);if(!Number.isNaN(a.getTime()))return L(a,e),a}return null}function lt(t){const e=t instanceof Date?t:new Date(t);if(Number.isNaN(e.getTime()))return null;const a=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),l=String(e.getDate()).padStart(2,"0");return`${a}-${r}-${l}`}function ut(t){const e=t instanceof Date?t:new Date(t);if(Number.isNaN(e.getTime()))return"N/A";const a=e.getDate(),r=h=>{const u=h%10,g=h%100;return u===1&&g!==11?"st":u===2&&g!==12?"nd":u===3&&g!==13?"rd":"th"},l=["January","February","March","April","May","June","July","August","September","October","November","December"];return`${a}${r(a)} of ${l[e.getMonth()]}, ${e.getFullYear()}`}function z(t){return ut(t)}function mt(t){const e=A(t.date,t.startTime);return!e||Number.isNaN(e.getTime())?!0:e.getTime()>=Date.now()}function pt(t){const e=A(t.date,t.startTime);return!e||Number.isNaN(e.getTime())?!1:e.getTime()<Date.now()}const q=new Map;async function G(t){if(q.has(t))return q.get(t);let e=t;try{const a=await ct(j(w,"users",t));if(a.exists()){const r=a.data();e=r.displayName||r.name||r.email||t}}catch{}return q.set(t,e),e}async function ft(t){const e=[];for(const a of t)e.push(await G(a));return e}document.addEventListener("DOMContentLoaded",()=>{const t=document.getElementById("hangoutForm"),e=document.getElementById("hangoutName"),a=document.getElementById("hangoutDate"),r=document.getElementById("hangoutStartTime"),l=document.getElementById("hangoutEndTime"),h=document.getElementById("hangoutLocation"),u=document.getElementById("hangoutDescription"),g=document.getElementById("friendsList"),C=document.getElementById("hangoutList"),T=document.getElementById("btnUpcoming"),D=document.getElementById("btnPast"),K=document.getElementById("hangoutDetailsModal"),Q=document.getElementById("hangoutDetailsTitle"),O=document.getElementById("hangoutDetailsBody"),W=new bootstrap.Modal(K),X=document.getElementById("editParticipantsModal"),F=new bootstrap.Modal(X),I=document.getElementById("editFriendsList"),Z=document.getElementById("saveParticipantsBtn");let S=[],H="upcoming",N=null,b=[],P=null;async function V(s){b=[];const n=R(w,"friendships"),c=U(n,$("fromUserId","==",s),$("status","==","accepted")),i=U(n,$("toUserId","==",s),$("status","==","accepted")),[d,m]=await Promise.all([_(c),_(i)]),p=new Set;d.forEach(o=>p.add(o.data().toUserId)),m.forEach(o=>p.add(o.data().fromUserId)),b=[];for(const o of p)b.push({uid:o,name:await G(o)});if(g){if(g.innerHTML="",!b.length){g.innerHTML='<div class="col-12 text-muted">No accepted friends yet.</div>';return}b.forEach(o=>{const f=document.createElement("div");f.className="col-12 col-md-4",f.innerHTML=`
                <div class="form-check">
                    <input
                        class="form-check-input"
                        type="checkbox"
                        value="${o.uid}"
                        id="friend-${o.uid}"
                    >
                    <label class="form-check-label" for="friend-${o.uid}">
                        ${o.name}
                    </label>
                </div>
            `,g.appendChild(f)})}}function J(){C.innerHTML="";const s=S.filter(n=>H==="upcoming"?mt(n):pt(n));if(!s.length){const n=document.createElement("li");n.className="list-group-item text-muted",n.textContent=H==="upcoming"?"No upcoming hangouts.":"No past hangouts.",C.appendChild(n);return}s.forEach(n=>{const c=document.createElement("li");c.className="list-group-item d-flex justify-content-between align-items-start";const i=document.createElement("div");i.className="me-3";const d=n.title||"(untitled hangout)",m=A(n.date),p=z(m),o=n.startTime||"",f=n.endTime||"",B=n.location||"",M=n.description||"",x=o?f?`${o}–${f}`:o:"";i.innerHTML=`
                <div class="fw-semibold">
                    ${d}${p!=="N/A"||x?` (${[p,x].filter(Boolean).join(" · ")})`:""}
                </div>
                ${B?`<div class="text-muted small">Location: ${B}</div>`:""}
                ${M?`<div class="small mt-1 text-truncate">${M}</div>`:""}
                ${Array.isArray(n.participants)&&n.participants.length?`<div class="small text-muted mt-1">Participants: ${n.participants.length}</div>`:""}
            `;const v=document.createElement("div");v.className="btn-group";const E=document.createElement("button");E.className="btn btn-sm btn-outline-secondary",E.textContent="View",E.addEventListener("click",()=>tt(n));const y=document.createElement("button");y.className="btn btn-sm btn-outline-primary",y.textContent="Edit participants",y.addEventListener("click",()=>et(n));const k=document.createElement("button");k.className="btn btn-sm btn-outline-danger",k.textContent="Delete",k.addEventListener("click",async()=>{if(confirm(`Delete hangout "${d}"?`))try{await ot(j(w,"hangouts",n.id))}catch(nt){console.error("Failed to delete hangout:",nt),alert("Failed to delete hangout.")}}),v.appendChild(E),v.appendChild(y),v.appendChild(k),c.appendChild(i),c.appendChild(v),C.appendChild(c)})}function tt(s){const n=s.title||"(untitled hangout)";Q.textContent=n;const c=z(A(s.date)),i=s.startTime?s.endTime?`${s.startTime} – ${s.endTime}`:s.startTime:"N/A",d=s.location||"N/A",m=s.description||"<span class='text-muted'>No description provided.</span>";O.innerHTML=`
            <p><strong>Date:</strong> ${c}</p>
            <p><strong>Time:</strong> ${i}</p>
            <p><strong>Location:</strong> ${d}</p>
            <p><strong>Description:</strong><br>${m}</p>
            <p>
                <strong>Participants:</strong><br>
                <span id="participantNames" class="text-muted">Loading…</span>
            </p>
        `,W.show(),(async()=>{const p=Array.isArray(s.participants)&&s.participants.length?s.participants:N?[N.uid]:[],o=await ft(p),f=O.querySelector("#participantNames");f&&(f.textContent=o.join(", "))})()}function et(s){if(P=s,I.innerHTML="",!b.length){I.innerHTML='<div class="col-12 text-muted">No accepted friends to add.</div>',F.show();return}b.forEach(n=>{const c=document.createElement("div");c.className="col-12";const i=Array.isArray(s.participants)&&s.participants.includes(n.uid)?"checked":"";c.innerHTML=`
                <div class="form-check">
                    <input
                        class="form-check-input"
                        type="checkbox"
                        value="${n.uid}"
                        id="edit-friend-${n.uid}"
                        ${i}
                    >
                    <label class="form-check-label" for="edit-friend-${n.uid}">
                        ${n.name}
                    </label>
                </div>
            `,I.appendChild(c)}),F.show()}Z.addEventListener("click",async()=>{if(!P||!N)return;const s=I.querySelectorAll('input[type="checkbox"]'),n=Array.from(s).filter(i=>i.checked).map(i=>i.value),c=Array.from(new Set([N.uid,...n]));try{await rt(j(w,"hangouts",P.id),{participants:c}),F.hide()}catch(i){console.error("Failed to save participants:",i),alert("Failed to save participants.")}});function Y(s){H=s,s==="upcoming"?(T.classList.add("active"),T.classList.replace("btn-outline-secondary","btn-outline-primary"),D.classList.remove("active"),D.classList.replace("btn-outline-primary","btn-outline-secondary")):(D.classList.add("active"),D.classList.replace("btn-outline-secondary","btn-outline-primary"),T.classList.remove("active"),T.classList.replace("btn-outline-primary","btn-outline-secondary")),J()}T.addEventListener("click",()=>Y("upcoming")),D.addEventListener("click",()=>Y("past")),dt(async s=>{if(!s){window.location.href="login.html";return}N=s,await V(s.uid);const n=R(w,"hangouts"),c=U(n,$("userId","==",s.uid));st(c,i=>{S=[],i.forEach(d=>{S.push({id:d.id,...d.data()})}),J()}),t.addEventListener("submit",async i=>{i.preventDefault();const d=e.value.trim(),m=a.value,p=r.value,o=l.value,f=h.value.trim(),B=u.value.trim();if(!d||!m||!p){alert("Please fill in hangout name, date, and start time.");return}const M=/^\d{4}-\d{2}-\d{2}$/.test(m)?m:lt(new Date(m))||m,x=g?g.querySelectorAll('input[type="checkbox"]:checked'):[],v=Array.from(x).map(y=>y.value),E=Array.from(new Set([s.uid,...v]));try{await at(n,{userId:s.uid,title:d,date:M,startTime:p,endTime:o||null,location:f||null,description:B||null,participants:E,status:"planned",createdAt:it()}),t.reset()}catch(y){console.error("Failed to create hangout:",y),alert(`Could not create hangout: ${y.code||y.message}`)}})})});
