import{q as b,w as o,e as E,o as L,b as H,c as M,i as N,a as u,s as w,g as A,d as q,j as v,u as k,k as x}from"./site-footer-DBBnyLh7.js";import{onAuthReady as O}from"./authentication-DYev4ouI.js";const U=new Map;async function Q(m){if(U.has(m))return U.get(m);let g=m;try{const y=await A(q(u,"users",m));if(y.exists()){const d=y.data();g=d.displayName||d.name||d.email||m}}catch{}return U.set(m,g),g}let I=null;document.addEventListener("DOMContentLoaded",()=>{const m=document.getElementById("addFriendForm"),g=document.getElementById("friendUserId"),y=document.getElementById("addFriendMessage"),d=document.getElementById("friendRequestsList"),h=document.getElementById("myFriendsList"),D=document.getElementById("requestCount"),j=document.getElementById("friendCount");if(!m||!g||!y||!d||!h){console.warn("Friends page DOM elements not ready");return}O(t=>{if(!t){window.location.href="login.html";return}I=t;const e=t.uid,n=b(E(u,"friendships"),o("toUserId","==",e),o("status","==","pending"));L(n,async f=>{d.innerHTML="";const c=f.docs.map(r=>({id:r.id,...r.data()}));if(D.textContent=c.length,!c.length){d.innerHTML='<li class="list-group-item text-muted">No pending requests.</li>';return}for(const r of c){const s=await F(r.fromUserId),a=document.createElement("li");a.className="list-group-item d-flex justify-content-between align-items-center";const l=s?.displayName||s?.email||r.fromUserId,$=s?.email||"";a.innerHTML=`
            <div>
              <strong>${l}</strong>
              <br><small class="text-muted">${$}</small>
            </div>
            <div class="btn-group btn-group-sm" role="group">
              <button class="btn btn-success btn-sm accept-btn" data-id="${r.id}">Accept</button>
              <button class="btn btn-danger btn-sm reject-btn" data-id="${r.id}">Reject</button>
            </div>
          `,d.appendChild(a)}d.querySelectorAll(".accept-btn").forEach(r=>{r.addEventListener("click",()=>T(r.dataset.id))}),d.querySelectorAll(".reject-btn").forEach(r=>{r.addEventListener("click",()=>P(r.dataset.id))})},f=>{console.error("Error listening to friend requests:",f)});const i=b(E(u,"friendships"),H(M(o("fromUserId","==",e),o("status","==","accepted")),M(o("toUserId","==",e),o("status","==","accepted"))));L(i,async f=>{const c=new Map;f.forEach(s=>{const a=s.data(),l=a.fromUserId===e?a.toUserId:a.fromUserId;c.has(l)?c.get(l).docIds.push(s.id):c.set(l,{friendId:l,docIds:[s.id]})});const r=[];for(const{friendId:s,docIds:a}of c.values()){const l=await F(s);r.push({friendId:s,docIds:a,name:l?.displayName||l?.email||await Q(s),email:l?.email||""})}if(j.textContent=r.length.toString(),h.innerHTML="",!r.length){h.innerHTML='<li class="list-group-item text-muted">No friends yet. Add some to get started!</li>';return}for(const s of r){const a=document.createElement("li");a.className="list-group-item d-flex justify-content-between align-items-center",a.innerHTML=`
            <div>
              <strong>${s.name}</strong>
              <br><small class="text-muted">${s.email}</small>
            </div>
            <button class="btn btn-outline-danger btn-sm remove-btn" data-docids="${s.docIds.join(",")}">Remove</button>
          `,h.appendChild(a)}h.querySelectorAll(".remove-btn").forEach(s=>{s.addEventListener("click",()=>R(s.dataset.docids.split(",")))})},f=>{console.error("Error listening to accepted friendships:",f)})}),m.addEventListener("submit",async t=>{if(t.preventDefault(),!I){p("Please log in first.","danger");return}const e=g.value.trim();if(!e){p("Please enter an email address.","danger");return}if(e===I.email){p("You cannot add yourself as a friend.","danger");return}try{const n=await B(e);if(!n){p("User not found. Please check the email address.","danger");return}if(await C(I.uid,n)){p("Friend request already sent or you are already friends.","warning");return}await N(E(u,"friendships"),{fromUserId:I.uid,toUserId:n,status:"pending",createdAt:w(),updatedAt:w()}),p("Friend request sent successfully!","success"),g.value=""}catch(n){console.error("Error sending friend request:",n),p("Failed to send friend request. Please try again.","danger")}});function p(t,e="info"){y.innerHTML=`
      <div class="alert alert-${e} alert-dismissible fade show" role="alert">
        ${t}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    `,setTimeout(()=>{y.innerHTML=""},5e3)}async function F(t){try{const e=await A(q(u,"users",t));return e.exists()?e.data():null}catch(e){return console.error("Error fetching user data:",e),null}}async function B(t){try{const e=E(u,"users"),n=b(e,o("email","==",t)),i=await v(n);return i.empty?null:i.docs[0].id}catch(e){return console.error("Error in getUserIdByEmail:",e),null}}async function C(t,e){try{const n=E(u,"friendships"),i=b(n,o("fromUserId","==",t),o("toUserId","==",e)),f=b(n,o("fromUserId","==",e),o("toUserId","==",t)),[c,r]=await Promise.all([v(i),v(f)]);return!c.empty||!r.empty}catch(n){return console.error("Error checking friendship:",n),!1}}async function T(t){try{await k(q(u,"friendships",t),{status:"accepted",updatedAt:w()})}catch(e){console.error("Error accepting friend request:",e),alert("Failed to accept friend request. Please try again.")}}async function P(t){if(confirm("Are you sure you want to reject this friend request?"))try{await x(q(u,"friendships",t))}catch(n){console.error("Error rejecting friend request:",n),alert("Failed to reject friend request. Please try again.")}}async function R(t){if(!confirm("Are you sure you want to remove this friend?"))return;const n=Array.isArray(t)?t:[t];try{await Promise.all(n.map(i=>x(q(u,"friendships",i))))}catch(i){console.error("Error removing friend:",i),alert("Failed to remove friend. Please try again.")}}});
